# Telegram 广告屏蔽插件 - 验证和测试指南

本文档提供详细的验证步骤，帮助您确认插件是否正常工作。

## 📋 前置检查清单

在开始验证之前，请确保已完成以下步骤：

- [ ] 已安装 Loon 3.2.0 或更高版本
- [ ] 已安装并信任 MITM 证书
- [ ] 已导入 Telegram 广告屏蔽插件
- [ ] 插件开关已开启（绿色）
- [ ] Loon VPN 已连接
- [ ] MITM 功能已启用

## 🔍 验证方法

### 方法一：日志验证（最可靠）

这是验证插件是否工作的最可靠方法。

#### 步骤 1：开启日志记录

1. 打开 **Loon** 应用
2. 点击底部 **「工具」** 标签
3. 点击 **「日志」**
4. 确保日志记录功能已开启

#### 步骤 2：访问 Telegram 频道

1. 打开 **Telegram** 应用
2. 访问以下任意一个大型频道（这些频道通常会显示赞助消息）：
   - 任何订阅数超过 10 万的热门频道
   - 新闻类频道
   - 加密货币相关频道
   - 科技类频道

3. 在频道中滚动浏览，确保加载了多条消息

#### 步骤 3：查看日志输出

1. 返回 **Loon** 应用
2. 查看 **「日志」** 页面
3. 寻找以下关键日志信息：

**成功拦截的日志示例**：
```
[Telegram AdBlocker v2.0.0] 处理请求: https://api.telegram.org/...
[Telegram AdBlocker v2.0.0] ✓ 移除 sponsoredMessages 字段 (1 条)
[Telegram AdBlocker v2.0.0] ✓ 成功移除 1 个广告项 (15234 -> 12456 bytes)
```

```
[Telegram AdBlocker v2.0.0] ✓ 移除频道完整信息中的赞助消息
[Telegram AdBlocker v2.0.0] ✓ 成功移除 2 个广告项 (28456 -> 21234 bytes)
```

**正常处理但无广告的日志示例**：
```
[Telegram AdBlocker v2.0.0] 处理请求: https://api.telegram.org/...
[Telegram AdBlocker v2.0.0] 处理完成 (12345 -> 12345 bytes)
```

#### 步骤 4：解读日志

| 日志内容 | 含义 | 结果 |
|---------|------|-----|
| `✓ 成功移除 X 个广告项` | 成功拦截并移除了广告 | ✅ 插件正常工作 |
| `处理完成 (相同大小)` | 响应中没有广告内容 | ✅ 插件正常工作 |
| 没有任何日志输出 | MITM 未生效或插件未启用 | ❌ 需要检查配置 |
| `❌ 处理异常` | 脚本执行出错 | ❌ 需要报告问题 |

### 方法二：视觉验证

通过直接观察 Telegram 界面来验证插件效果。

#### 步骤 1：识别赞助消息特征

赞助消息通常有以下特征：
- 显示在频道顶部（第一条消息位置）
- 带有蓝色 **"广告"** 标签（中文版）
- 或带有蓝色 **"Sponsored"** 标签（英文版）
- 右侧有 **"这是什么"** 或 **"What's this"** 链接
- 消息内容通常是推广其他频道或产品

#### 步骤 2：对比测试

1. **测试前**（插件关闭状态）：
   - 在 Loon 中临时关闭 Telegram 广告屏蔽插件
   - 完全关闭 Telegram 应用（从后台移除）
   - 重新打开 Telegram
   - 访问大型频道
   - 观察是否能看到带有 "广告" 标签的赞助消息
   - 截图保存（可选）

2. **测试后**（插件开启状态）：
   - 在 Loon 中开启 Telegram 广告屏蔽插件
   - 完全关闭 Telegram 应用（从后台移除）
   - 重新打开 Telegram
   - 访问同一个频道
   - 观察赞助消息是否消失
   - 频道顶部应该直接显示正常的频道消息

#### 步骤 3：验证结果

| 观察结果 | 插件状态 |
|---------|---------|
| 关闭插件时看到 "广告"，开启后看不到 | ✅ 插件工作正常 |
| 开启插件后仍然看到 "广告" | ❌ 插件未生效，需检查配置 |
| 始终看不到 "广告" | ℹ️ 当前频道可能没有赞助消息 |

### 方法三：网络请求监控

通过 Loon 的网络请求记录验证 MITM 是否正常拦截 Telegram 流量。

#### 步骤 1：开启请求记录

1. 打开 **Loon** 应用
2. 点击 **「历史请求」** 或 **「工具」** → **「最近请求」**

#### 步骤 2：查看 Telegram 请求

1. 打开 Telegram 并浏览频道
2. 返回 Loon 查看请求记录
3. 寻找包含以下域名的请求：
   - `api.telegram.org`
   - `apiv2.telegram.org`
   - `web.telegram.org`
   - 或其他 `*.telegram.org` 域名

#### 步骤 3：检查脚本执行

1. 点击任意 Telegram 相关的请求
2. 查看请求详情
3. 确认是否有 **「Telegram去广告」** 脚本标记
4. 查看脚本执行状态（成功/失败）

#### 验证结果

| 观察结果 | 说明 |
|---------|-----|
| 能看到 telegram.org 请求，有脚本标记 | ✅ MITM 和脚本都正常工作 |
| 能看到 telegram.org 请求，无脚本标记 | ⚠️ MITM 工作但脚本未执行 |
| 看不到 telegram.org 请求 | ❌ MITM 未拦截 Telegram 流量 |

## 🧪 高级测试

### 测试场景 1：多个频道测试

访问至少 3-5 个不同的大型频道，验证插件在不同频道中的表现是否一致。

**推荐测试频道类型**：
- 新闻频道
- 科技频道
- 加密货币频道
- 娱乐频道
- 本地新闻频道

### 测试场景 2：不同时间段测试

在不同时间段测试，因为广告的投放可能有时间规律：
- 早晨（8:00 - 10:00）
- 中午（12:00 - 14:00）
- 晚上（18:00 - 22:00）

### 测试场景 3：网络切换测试

测试在不同网络环境下插件的稳定性：
- WiFi 网络
- 4G/5G 移动网络
- 切换网络后重新连接

### 测试场景 4：性能测试

观察启用插件前后的性能差异：
- 频道加载速度
- 消息滚动流畅度
- Telegram 整体响应速度

**预期结果**：插件应该不会明显影响 Telegram 的使用体验。

## 🔧 故障诊断流程

如果插件未按预期工作，请按照以下流程进行诊断：

### 诊断流程图

```
开始
 ↓
检查 Loon VPN 是否连接？
 ├─ 否 → 连接 Loon VPN → 重新测试
 ↓
检查插件是否启用？
 ├─ 否 → 启用插件 → 重新测试
 ↓
检查 MITM 是否开启？
 ├─ 否 → 开启 MITM → 重新测试
 ↓
检查证书是否信任？
 ├─ 否 → 安装并信任证书 → 重新测试
 ↓
查看 Loon 日志是否有脚本输出？
 ├─ 否 → 检查 MITM 主机名配置 → 添加 telegram.org 相关域名
 ↓
日志是否显示错误？
 ├─ 是 → 记录错误信息 → 提交 Issue
 ↓
是否有 "成功移除" 日志？
 ├─ 是 → 插件工作正常，可能当前频道无广告
 ├─ 否 → 尝试访问更多频道 → 如仍无效，提交 Issue
 ↓
结束
```

### 常见问题快速检查

运行以下快速检查清单：

```
□ Loon 版本 >= 3.2.0
□ VPN 图标显示在状态栏
□ MITM 开关为开启状态
□ 证书在"证书信任设置"中已启用
□ 插件列表中显示"Telegram 广告屏蔽"
□ 插件开关为开启状态（绿色）
□ MITM 主机名包含 *.telegram.org
□ 日志中能看到 telegram.org 的请求
□ 完全关闭并重启过 Telegram
```

## 📊 预期效果

### 成功拦截后的效果

1. **频道浏览体验**：
   - 不再看到顶部带有 "广告" 标签的消息
   - 频道消息直接从第一条正常消息开始显示
   - 浏览更加流畅，没有广告干扰

2. **日志输出**：
   - 定期看到 "成功移除 X 个广告项" 的日志
   - 数据大小有明显变化（XX -> YY bytes）
   - 无错误或异常日志

3. **Telegram 功能**：
   - 所有正常功能不受影响
   - 消息收发正常
   - 媒体加载正常
   - 频道搜索正常
   - 设置和通知正常

### 不影响的功能

以下功能应该完全不受插件影响：
- ✅ 私聊消息
- ✅ 群组消息
- ✅ 频道正常消息
- ✅ 媒体文件（图片、视频、文件）
- ✅ 语音和视频通话
- ✅ 搜索功能
- ✅ 设置和账户管理
- ✅ 通知推送

## 📝 问题报告模板

如果验证过程中发现问题，请按照以下模板提交 Issue：

```markdown
### 问题描述
[简要描述遇到的问题]

### 验证结果
- [ ] 方法一（日志验证）：[通过/失败]
- [ ] 方法二（视觉验证）：[通过/失败]
- [ ] 方法三（网络监控）：[通过/失败]

### 环境信息
- iOS 版本：[例如：iOS 17.1]
- Loon 版本：[例如：3.2.1]
- Telegram 版本：[例如：10.2.1]
- 插件版本：[例如：v2.0.0]

### 配置信息
- [ ] MITM 已启用
- [ ] 证书已信任
- [ ] 插件已启用
- [ ] MITM 主机名包含 telegram.org 相关域名

### 日志输出
```
[粘贴相关的 Loon 日志]
```

### 截图
[如果可能，提供以下截图]
- Loon 插件列表截图
- Loon 日志截图
- Telegram 赞助消息截图（如果仍然显示）

### 重现步骤
1. [第一步]
2. [第二步]
3. [第三步]

### 预期行为
[描述您期望的正常行为]

### 实际行为
[描述实际发生的情况]
```

## 🎯 验证成功标准

只有满足以下所有条件，才能认为插件验证成功：

1. ✅ Loon 日志中能看到 `[Telegram AdBlocker v2.0.0]` 输出
2. ✅ 访问多个频道后至少看到几次 "成功移除" 日志
3. ✅ 视觉上看不到带有 "广告" 标签的赞助消息
4. ✅ Telegram 所有正常功能不受影响
5. ✅ 没有错误或异常日志输出

如果满足以上所有条件，恭喜您！插件已成功安装并正常工作。🎉

---

如有任何疑问，请访问 [GitHub Issues](https://github.com/g1z2f/loon-telegram-adblocker-/issues) 提交问题。
