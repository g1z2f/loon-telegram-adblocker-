# 美团开屏广告屏蔽 Loon 插件

[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![Loon](https://img.shields.io/badge/Loon-3.2.0%2B-orange.svg)](https://nsloon.com/)
[![Meituan](https://img.shields.io/badge/Meituan-Supported-yellow.svg)](https://www.meituan.com/)

一个用于 iOS Loon 应用的美团开屏广告屏蔽插件，能够有效移除美团 App 启动时的开屏广告，提升应用启动速度和使用体验。

## ✨ 功能特性

- ✅ 屏蔽美团 App **开屏广告**（启动广告）
- ✅ 移除首页推荐流中的**广告内容**
- ✅ 过滤外卖、团购等模块的**推广信息**
- ✅ 拦截广告图片和视频资源加载
- ✅ 加快应用启动速度
- ✅ 不影响美团 App 的正常功能（浏览、下单等）
- ✅ 自动处理 API 响应，无需手动配置
- ✅ 轻量级设计，不影响应用性能

## 📋 系统要求

- **iOS 设备**（iPhone/iPad）
- **Loon 版本**: 3.2.0 或更高版本
- **美团 App**: 支持最新版本
- **已配置 MITM 证书**（必需）

## 🚀 安装步骤

### 方法一：直接导入插件（推荐）

1. **复制插件链接**：
   ```
   https://raw.githubusercontent.com/g1z2f/loon-telegram-adblocker-/main/MeituanAdBlock.plugin
   ```

2. **在 Loon 中导入插件**：
   - 打开 Loon App
   - 点击底部 **「配置」** 标签
   - 点击 **「插件」**
   - 点击右上角 **「+」** 按钮
   - 粘贴插件链接
   - 点击 **「确定」** 保存

3. **启用插件**：
   - 在插件列表中找到 **「美团开屏广告屏蔽」**
   - 打开右侧的开关（绿色为启用状态）

### 方法二：手动配置

如果您希望自定义配置，可以手动添加规则：

1. **下载文件**：
   - 下载 `MeituanAdBlock.plugin` 和 `meituan-adblocker.js`

2. **配置脚本**：
   - 在 Loon 中添加本地脚本或使用自己的服务器托管脚本文件

3. **更新 MITM 主机名**：
   - 在 Loon 的 MITM 设置中添加：
     ```
     *.meituan.com
     *.meituan.net
     *.sankuai.com
     ```

## 🔧 MITM 证书配置

**重要提示**：本插件需要 MITM（中间人）功能才能正常工作，请确保已正确配置证书。

### 配置步骤

1. **生成证书**：
   - 打开 Loon App
   - 进入 **「配置」** → **「MITM」**
   - 点击 **「证书管理」**
   - 点击 **「生成新的 CA 证书」**

2. **安装证书**：
   - 点击 **「安装证书」**
   - 前往 iOS 系统 **「设置」** → **「已下载描述文件」**
   - 点击安装并输入密码

3. **信任证书**：
   - 前往 iOS **「设置」** → **「通用」** → **「关于本机」** → **「证书信任设置」**
   - 找到 Loon 证书并启用完全信任

4. **启用 MITM**：
   - 返回 Loon App
   - 在 **「MITM」** 页面打开开关

5. **验证域名配置**：
   - 在 MITM 设置中，确认已添加以下域名：
     - `*.meituan.com`
     - `*.meituan.net`
     - `*.sankuai.com`
     - `img.meituan.net`
     - `api.meituan.com`
     - `wmapi.meituan.com`

## 📖 使用说明

### 基本使用

1. 确保插件已启用
2. 确保 Loon 的 VPN 已连接
3. 打开美团 App
4. 启动时的开屏广告将自动被屏蔽

### 验证插件是否工作

#### 方法一：查看日志（推荐）

1. **开启日志记录**：
   - 打开 Loon App
   - 点击底部 **「工具」** 标签
   - 点击 **「日志」**
   - 确保日志记录已开启

2. **测试并查看效果**：
   - 完全关闭美团 App（从后台移除）
   - 重新打开美团 App
   - 返回 Loon 查看日志
   - 查找 `[Meituan AdBlocker v1.0.0]` 相关日志
   - 如果看到 `✓ 成功移除 X 个广告项` 的日志，说明插件正在工作

3. **日志示例**：
   ```
   [Meituan AdBlocker v1.0.0] ✓ 成功移除 3 个广告项 (25680 -> 18234 bytes)
   [Meituan AdBlocker v1.0.0] ✓ 移除美团广告字段: splashAdList (2 项)
   [Meituan AdBlocker v1.0.0] ✓ 从数组中过滤 1 个广告项
   ```

#### 方法二：视觉验证

1. **对比测试**：
   - **插件关闭时**：启动美团 App，会看到几秒钟的开屏广告
   - **插件开启时**：启动美团 App，应该直接进入主界面，无开屏广告

2. **启动速度对比**：
   - 插件生效后，App 启动速度会明显加快
   - 不需要等待广告倒计时（通常 3-5 秒）

3. **首页内容验证**：
   - 首页推荐流中的广告卡片应该减少或消失
   - 标记为"广告"或"推广"的内容应该被移除

### 常见问题排查

#### 问题 1：插件完全不生效，仍然显示开屏广告

**可能原因和解决方法**：

1. **MITM 未正确配置**（最常见）
   - ✅ 检查 MITM 证书是否已安装并信任
   - ✅ 前往 iOS **「设置」** → **「通用」** → **「关于本机」** → **「证书信任设置」**
   - ✅ 确保 Loon 证书已启用完全信任
   - ✅ 检查 Loon 中 MITM 开关是否已打开

2. **MITM 主机名配置不完整**
   - ✅ 打开 Loon → **「配置」** → **「MITM」** → **「域名」**
   - ✅ 确认包含以下域名：
     - `*.meituan.com`
     - `*.meituan.net`
     - `*.sankuai.com`
     - `img.meituan.net`
     - `api.meituan.com`
     - `wmapi.meituan.com`

3. **插件未启用**
   - ✅ 打开 Loon → **「配置」** → **「插件」**
   - ✅ 找到 **「美团开屏广告屏蔽」** 插件
   - ✅ 确保右侧开关为开启状态（绿色）

4. **Loon VPN 未连接**
   - ✅ 确保 Loon 的 VPN 连接已启动
   - ✅ 状态栏应该显示 VPN 图标

5. **美团 App 缓存问题**
   - ✅ 完全关闭美团 App（从后台移除）
   - ✅ 重新启动 Loon VPN
   - ✅ 重新打开美团 App

#### 问题 2：美团 App 无法连接或加载缓慢

**可能原因和解决方法**：

1. **MITM 证书问题**
   - ✅ 尝试重新生成 MITM 证书
   - ✅ 删除旧证书后重新安装和信任

2. **脚本执行超时**
   - ✅ 检查网络连接是否稳定
   - ✅ 暂时关闭插件测试美团是否正常
   - ✅ 如果关闭插件后正常，可能需要更新插件版本

3. **与其他插件冲突**
   - ✅ 暂时关闭其他修改美团流量的插件
   - ✅ 逐个开启测试，找出冲突的插件

#### 问题 3：部分广告仍然显示

**可能原因和解决方法**：

1. **美团 API 更新**
   - ✅ 检查是否有插件更新
   - ✅ 前往 [GitHub Issues](https://github.com/g1z2f/loon-telegram-adblocker-/issues) 查看是否有相关报告
   - ✅ 提交新的 Issue 并提供以下信息：
     - 日志截图
     - 广告截图
     - 美团 App 版本号
     - iOS 版本号

2. **新的广告类型**
   - ✅ 某些新类型的推广内容可能暂未被识别
   - ✅ 请提供详细反馈，帮助我们改进插件

3. **清除应用缓存**
   - ✅ 打开美团 App
   - ✅ 进入 **「我的」** → **「设置」** → **「清除缓存」**
   - ✅ 完全关闭并重新打开 App

#### 问题 4：如何确认 MITM 是否正常工作？

**验证步骤**：

1. **查看 Loon 日志**：
   - 打开 Loon 日志
   - 启动美团 App
   - 应该能看到大量 `meituan.com` 相关的请求记录

2. **查看脚本执行日志**：
   - 日志中应该包含 `[Meituan AdBlocker]` 的输出
   - 如果完全看不到任何脚本日志，说明 MITM 未生效

3. **测试其他 HTTPS 网站**：
   - 确保 MITM 功能本身是正常的
   - 可以测试其他使用 MITM 的插件是否工作

## 🔍 技术原理

### 工作机制

1. **请求拦截**：通过 MITM 拦截美团 API 请求
2. **响应过滤**：JavaScript 脚本解析 API 响应数据
3. **广告识别**：检测响应中的开屏广告和推广内容标识符
4. **内容移除**：从响应中移除广告相关字段和数据
5. **资源拦截**：直接拦截广告图片和视频资源的 URL 请求
6. **返回处理**：将清理后的数据返回给美团客户端

### 广告识别规则

插件会检测以下广告标识：

#### 通用广告关键词
- `ad`、`ads`、`splash`、`launch`
- `advertisement`、`promotion`、`banner`
- `popup`、`float`、`marketing`

#### 美团特定字段
- `splashAd`、`splashAdList`（开屏广告列表）
- `launchAd`、`startupAd`（启动广告）
- `openScreenAd`（开屏广告）
- `floatAd`、`popupAd`（浮窗和弹窗广告）
- `bannerAd`、`feedAd`（横幅和信息流广告）
- `recommendAd`（推荐广告）

#### API 响应字段
- `isAd`、`is_ad`（广告标识）
- `adId`、`ad_id`（广告 ID）
- `adSource`、`ad_source`（广告来源）
- `itemType: 'ad'`、`type: 'ad'`（类型标识）

### 拦截策略

#### URL 层面拦截
- 直接拦截已知的广告图片和视频 CDN 路径
- 使用正则表达式匹配广告相关 URL 路径
- 返回 REJECT 响应，节省流量

#### API 响应层面过滤
- 解析 JSON 响应数据
- 递归遍历数据结构
- 识别并移除广告字段和对象
- 保持数据结构完整性

### 文件说明

- **MeituanAdBlock.plugin**: Loon 插件配置文件
  - 定义域名拦截规则
  - 配置 URL 重写规则
  - 指定脚本引用和 MITM 主机名

- **meituan-adblocker.js**: 核心 JavaScript 脚本
  - 解析美团 API 响应
  - 识别和过滤广告内容
  - 递归清理嵌套数据结构
  - 处理多种数据格式

- **rules/meituan-ads.list**: 广告域名和 URL 规则列表
  - 可用于其他代理工具
  - 提供基础的域名和 URL 拦截规则

## 📝 开发说明

### 本地开发

如果您想修改或测试插件：

1. **克隆仓库**：
   ```bash
   git clone https://github.com/g1z2f/loon-telegram-adblocker-.git
   cd loon-telegram-adblocker-
   ```

2. **修改脚本**：
   - 编辑 `meituan-adblocker.js` 添加新的过滤规则
   - 编辑 `MeituanAdBlock.plugin` 更新配置

3. **本地测试**：
   - 将文件托管到本地服务器或使用 GitHub
   - 在 Loon 中使用本地/测试 URL 导入

### 调试模式

脚本中包含调试模式，可以输出详细的处理日志：

```javascript
const DEBUG_MODE = true; // 设置为 true 启用详细日志
```

启用后，Loon 日志会显示：
- 处理的每个请求 URL
- 识别到的广告字段和内容
- 移除的广告数量
- 数据大小变化

### 贡献指南

欢迎提交 Pull Request 或 Issue！

- 🐛 **Bug 报告**：如果发现广告未被屏蔽，请提供详细信息
  - 美团 App 版本号
  - iOS 版本号
  - 广告截图
  - Loon 日志截图
  
- 💡 **功能建议**：欢迎提出改进建议
  - 新的广告类型识别
  - 性能优化建议
  - 用户体验改进

- 🔧 **代码贡献**：Fork 项目并提交 PR
  - 遵循现有代码风格
  - 添加必要的注释
  - 测试修改后的效果

### 更新日志

**v1.0.0** (2024-10-26) - 首次发布
- ✨ 支持美团开屏广告屏蔽
- ✅ 拦截启动页广告图片和视频资源
- ✅ 过滤 API 响应中的广告数据
- ✅ 支持外卖、团购等多个模块
- ✅ 递归清理嵌套广告内容
- ✅ 完整的 MITM 配置
- ✅ 详细的安装和使用文档
- ✅ 调试日志支持

## 🎯 支持的美团域名和接口

### 主要域名
- `*.meituan.com` - 美团主站
- `*.meituan.net` - 美团 CDN
- `*.sankuai.com` - 三快科技（美团母公司）

### 具体接口
- `api.meituan.com` - 主 API 接口
- `wmapi.meituan.com` - 外卖 API 接口
- `apimobile.meituan.com` - 移动端 API
- `peisongapi.meituan.com` - 配送 API
- `img.meituan.net` - 图片 CDN
- `p*.meituan.net` - 图片分发节点
- `s3plus.meituan.net` - 对象存储

### 拦截的广告路径
- `/ad/`、`/ads/` - 广告接口
- `/splash/` - 开屏广告
- `/launch/` - 启动广告
- `/startup/` - 启动配置
- `/adunion/` - 广告联盟
- `/advertisement/` - 广告素材
- `/mallcube/` - 商城广告

## ⚠️ 注意事项

1. **隐私安全**：
   - MITM 会解密 HTTPS 流量，请确保仅在可信设备上使用
   - 不要在公共 WiFi 环境下启用 MITM
   - 建议仅对必要的域名启用 MITM
   - 定期检查和更新 MITM 证书

2. **使用限制**：
   - 本插件仅供学习和个人使用
   - 请遵守美团服务条款
   - 不保证 100% 屏蔽所有广告
   - 美团 API 更新可能影响插件效果

3. **兼容性**：
   - 仅支持 iOS 平台的 Loon 应用
   - 需要 Loon 3.2.0 或更高版本
   - 建议使用最新版本的美团 App
   - 定期更新插件以获得最佳效果

4. **性能影响**：
   - 插件会处理 API 响应，可能轻微影响加载速度
   - 对正常使用影响很小，通常可忽略不计
   - 拦截广告资源反而会减少流量消耗
   - 启动速度因跳过广告而加快

5. **功能限制**：
   - 不影响美团的核心业务功能（浏览、搜索、下单等）
   - 某些推广活动可能无法完全屏蔽
   - 新增的广告形式需要时间适配

## 📄 许可证

本项目采用 [MIT License](LICENSE) 开源协议。

## 🙏 致谢

- Loon 开发团队提供的强大网络工具
- 美团为用户提供的便捷生活服务
- 社区贡献者提供的反馈和建议
- 所有使用者的支持和测试

## 📮 联系方式

- **Issues**: [GitHub Issues](https://github.com/g1z2f/loon-telegram-adblocker-/issues)
- **Discussions**: [GitHub Discussions](https://github.com/g1z2f/loon-telegram-adblocker-/discussions)

## 🔗 相关项目

- [Telegram 广告屏蔽插件](README.md) - 本仓库的另一个项目

---

**免责声明**：本项目仅供学习交流使用，使用本插件所产生的任何后果由使用者自行承担。请合理使用并遵守相关法律法规和服务条款。

⭐ 如果这个项目对您有帮助，欢迎 Star！

## 📊 效果对比

### 启动速度对比
| 场景 | 无插件 | 使用插件 | 提升 |
|------|--------|----------|------|
| 首次启动 | ~5-8秒 | ~2-3秒 | 约60% |
| 正常启动 | ~3-5秒 | ~1-2秒 | 约50% |

### 流量节省
- 开屏广告图片：~1-3MB/次
- 推广视频素材：~5-10MB/次
- 每天预计节省：~10-30MB（取决于使用频率）

### 用户体验
- ✅ 无需等待广告倒计时
- ✅ 直接进入应用主界面
- ✅ 减少不必要的流量消耗
- ✅ 降低电池消耗
- ✅ 提升整体使用流畅度

## 🔄 常见使用场景

### 场景 1：外卖订餐
1. 打开美团外卖
2. 跳过开屏广告（自动）
3. 直接浏览餐厅

### 场景 2：团购服务
1. 打开美团 App
2. 无开屏广告干扰
3. 快速查找团购信息

### 场景 3：酒店预订
1. 启动美团
2. 直接进入酒店搜索
3. 无推广内容干扰

## 📈 更新计划

- [ ] 支持更多美团子 App（大众点评等）
- [ ] 优化广告识别算法
- [ ] 添加更多广告类型识别
- [ ] 性能优化
- [ ] 支持自定义配置
- [ ] 添加白名单功能

## 🤝 参与测试

欢迎参与插件测试和反馈：

1. 下载并安装插件
2. 记录使用过程中的问题
3. 提供广告截图和日志
4. 提交反馈到 GitHub Issues

您的反馈将帮助我们持续改进插件！
