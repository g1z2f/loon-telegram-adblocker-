# 美团开屏广告屏蔽插件 - 安装指南

本文档提供美团开屏广告屏蔽插件的详细安装和配置步骤。

## 📋 前置要求

在开始安装之前，请确保：

- ✅ 您已安装 iOS Loon 应用（版本 3.2.0 或更高）
- ✅ 您已安装美团 App
- ✅ 您的设备运行 iOS 13 或更高版本
- ✅ 您有基本的 iOS 操作经验

## 🚀 快速安装（推荐新手）

### 第一步：安装和配置 MITM 证书

这是最关键的一步，必须正确完成才能使插件生效。

#### 1.1 生成证书

1. 打开 **Loon** App
2. 点击底部导航栏的 **「配置」** 标签
3. 滚动到底部，点击 **「MITM」**
4. 点击 **「证书管理」**
5. 点击 **「生成新的 CA 证书」**
   - 如果之前已生成过证书，可以继续使用
   - 如果遇到问题，可以删除旧证书后重新生成

#### 1.2 安装证书到系统

1. 在证书管理页面，点击 **「安装证书」**
2. 会弹出安装描述文件的提示，点击 **「允许」**
3. 返回 iOS 系统的 **「设置」** App
4. 在设置顶部会看到 **「已下载描述文件」** 提示
5. 点击进入，然后点击 **「安装」**
6. 输入设备密码或使用面容 ID/触控 ID 确认
7. 点击右上角的 **「安装」**，再次点击 **「安装」** 确认
8. 安装完成后点击 **「完成」**

#### 1.3 信任证书（重要！）

这一步经常被忽略，但非常关键：

1. 打开 iOS **「设置」** App
2. 依次点击：**「通用」** → **「关于本机」**
3. 滚动到底部，点击 **「证书信任设置」**
4. 找到 **「Loon CA」** 或类似名称的证书
5. 打开右侧的开关（开启后会变成绿色）
6. 在弹出的警告对话框中点击 **「继续」**

✅ **验证证书安装**：
- 返回 Loon → 配置 → MITM → 证书管理
- 应该显示证书已安装且受信任

#### 1.4 启用 MITM 功能

1. 在 Loon 的 MITM 页面
2. 打开顶部的 **「MITM」** 总开关（变为绿色）
3. 确保状态显示为"已启用"

### 第二步：导入美团广告屏蔽插件

#### 2.1 复制插件链接

选择以下链接并复制：

```
https://raw.githubusercontent.com/g1z2f/loon-telegram-adblocker-/main/MeituanAdBlock.plugin
```

**提示**：长按上方链接，选择"拷贝"

#### 2.2 在 Loon 中添加插件

1. 打开 **Loon** App
2. 点击底部的 **「配置」** 标签
3. 点击 **「插件」** 选项
4. 点击右上角的 **「+」** 按钮
5. 在弹出的输入框中：
   - **插件名称**：自动识别（美团开屏广告屏蔽）
   - **插件 URL**：粘贴刚才复制的链接
6. 点击 **「确定」** 保存

#### 2.3 启用插件

1. 在插件列表中，找到 **「美团开屏广告屏蔽」**
2. 确保右侧的开关处于打开状态（绿色）
3. 如果是灰色，点击开关启用

### 第三步：配置 MITM 域名

插件会自动配置必要的域名，但建议手动验证：

1. 在 Loon 中，进入 **「配置」** → **「MITM」**
2. 点击 **「域名」**
3. 确认列表中包含以下域名（如果没有，手动添加）：
   ```
   *.meituan.com
   *.meituan.net
   *.sankuai.com
   ```

**添加域名的方法**：
1. 点击右上角的 **「+」** 按钮
2. 输入域名（例如：`*.meituan.com`）
3. 点击 **「确定」**

### 第四步：启动 Loon VPN

1. 返回 Loon 首页
2. 点击中间的圆形按钮启动 VPN
3. 首次启动会提示添加 VPN 配置，点击 **「允许」**
4. 验证设备密码或面容 ID/触控 ID
5. 等待连接成功（按钮变为绿色，显示"已连接"）

### 第五步：测试插件效果

1. **完全关闭美团 App**（从后台移除）
   - 双击 Home 键或上滑底部横条
   - 找到美团 App，上滑关闭

2. **重新打开美团 App**
   - 正常情况下会跳过开屏广告
   - 直接进入主界面

3. **查看 Loon 日志验证**：
   - 打开 Loon → 工具 → 日志
   - 查找 `[Meituan AdBlocker]` 相关日志
   - 如果看到 `✓ 成功移除 X 个广告项`，说明插件正在工作

## 🔍 验证安装是否成功

### 检查清单

- ☑️ MITM 证书已安装
- ☑️ MITM 证书已信任（在系统设置中）
- ☑️ MITM 功能已启用（Loon 中的开关是绿色）
- ☑️ 插件已添加到列表
- ☑️ 插件已启用（开关是绿色）
- ☑️ MITM 域名包含 `*.meituan.com` 等
- ☑️ Loon VPN 已连接
- ☑️ 美团 App 启动时无开屏广告

### 查看日志

**开启日志记录**：
1. Loon → 工具 → 日志
2. 打开 **「记录日志」** 开关
3. 重新启动美团 App
4. 查看日志输出

**正常工作时的日志示例**：
```
[Meituan AdBlocker v1.0.0] 处理请求: https://api.meituan.com/...
[Meituan AdBlocker v1.0.0] ✓ 移除美团广告字段: splashAdList (2 项)
[Meituan AdBlocker v1.0.0] ✓ 成功移除 3 个广告项 (25680 -> 18234 bytes)
```

## ❗ 常见问题解决

### 问题 1：插件不生效，仍然显示开屏广告

**解决步骤**：

1. **检查 MITM 证书信任状态**
   ```
   iOS 设置 → 通用 → 关于本机 → 证书信任设置
   → 确保 Loon CA 开关已打开
   ```

2. **检查 MITM 功能是否启用**
   ```
   Loon → 配置 → MITM → 确保总开关已打开
   ```

3. **检查 MITM 域名配置**
   ```
   Loon → 配置 → MITM → 域名
   → 确认包含 *.meituan.com, *.meituan.net, *.sankuai.com
   ```

4. **检查插件状态**
   ```
   Loon → 配置 → 插件
   → 确认"美团开屏广告屏蔽"开关已打开（绿色）
   ```

5. **重启所有服务**
   ```
   1. 关闭 Loon VPN
   2. 完全关闭美团 App（从后台移除）
   3. 重新启动 Loon VPN
   4. 重新打开美团 App
   ```

### 问题 2：MITM 证书无法安装

**解决方法**：

1. **删除旧证书**：
   - iOS 设置 → 通用 → VPN 与设备管理
   - 找到旧的 Loon 描述文件，删除
   - iOS 设置 → 通用 → 关于本机 → 证书信任设置
   - 关闭旧证书的信任

2. **重新生成并安装**：
   - Loon → 配置 → MITM → 证书管理
   - 删除现有证书
   - 生成新的 CA 证书
   - 重新安装和信任

### 问题 3：美团 App 无法连接网络

**可能原因**：MITM 配置错误或证书问题

**解决方法**：

1. **暂时关闭插件**测试：
   - Loon → 配置 → 插件
   - 关闭"美团开屏广告屏蔽"
   - 测试美团是否正常

2. **检查网络连接**：
   - 确保设备有网络连接
   - 测试其他 App 是否正常

3. **重新配置 MITM**：
   - 删除并重新安装 MITM 证书
   - 重新添加 MITM 域名

### 问题 4：插件在 WiFi 下工作，但移动网络不工作

**解决方法**：

1. 检查 Loon 的网络权限：
   - iOS 设置 → Loon → 确保"无线数据"已启用

2. 检查 VPN 配置：
   - Loon → 配置 → 确保"允许通过蜂窝网络连接"已启用

### 问题 5：证书信任设置中找不到 Loon 证书

**解决方法**：

1. 确认证书已安装：
   - iOS 设置 → 通用 → VPN 与设备管理
   - 应该能看到 Loon 的描述文件

2. 如果未安装：
   - 重新执行证书安装步骤
   - 确保在安装描述文件时点击了"安装"

3. 如果已安装但找不到信任选项：
   - 重启设备
   - 重新检查证书信任设置

## 📱 各 iOS 版本的差异

### iOS 15-17

证书信任设置路径：
```
设置 → 通用 → 关于本机 → 证书信任设置
```

### iOS 14 及更早版本

证书信任设置路径可能略有不同，但通常在：
```
设置 → 通用 → 关于本机 → 证书信任设置
```

## 🎯 进阶配置

### 自定义脚本路径

如果您想使用自己托管的脚本：

1. 下载 `meituan-adblocker.js`
2. 上传到您的服务器或 GitHub
3. 编辑插件配置，修改 `script-path` 为您的 URL

### 调整日志级别

编辑 `meituan-adblocker.js`，修改：

```javascript
const DEBUG_MODE = false; // 改为 false 减少日志输出
```

### 添加自定义规则

如需添加更多拦截规则，编辑插件文件的 `[URL Rewrite]` 部分：

```
^https?:\/\/your-custom-rule\/.+ - reject
```

## 📞 获取帮助

如果以上方法都无法解决您的问题：

1. **查看详细文档**：[README_MEITUAN.md](README_MEITUAN.md)
2. **提交 Issue**：[GitHub Issues](https://github.com/g1z2f/loon-telegram-adblocker-/issues)
3. **加入讨论**：[GitHub Discussions](https://github.com/g1z2f/loon-telegram-adblocker-/discussions)

提交问题时，请提供：
- iOS 版本
- Loon 版本
- 美团 App 版本
- 问题截图
- Loon 日志截图

## ✅ 安装成功标志

当您看到以下情况时，说明安装成功：

1. ✅ 打开美团 App 时，无开屏广告
2. ✅ 应用启动速度明显加快
3. ✅ Loon 日志中有 `[Meituan AdBlocker]` 的成功日志
4. ✅ 美团的正常功能（浏览、下单等）不受影响

恭喜！您已成功安装并配置了美团开屏广告屏蔽插件。

---

**提示**：定期检查插件更新，以获得最佳广告屏蔽效果。
