# 安装指南

本文档提供详细的 Telegram 广告屏蔽插件安装和配置指南。

## 目录

1. [前置准备](#前置准备)
2. [安装插件](#安装插件)
3. [配置 MITM](#配置-mitm)
4. [验证安装](#验证安装)
5. [问题排查](#问题排查)

## 前置准备

### 1. 检查设备要求

- ✅ iOS 14.0 或更高版本
- ✅ Loon 应用已安装（版本 3.2.0+）
- ✅ 设备可以正常访问网络

### 2. 购买和配置 Loon

如果您还没有安装 Loon：

1. 前往 App Store 搜索 **"Loon"**
2. 购买并下载应用（需付费）
3. 首次打开 Loon，按照提示完成基础配置

## 安装插件

### 方式一：远程导入（最简单）

**步骤 1：复制插件 URL**

复制以下链接（将来需要替换为实际的 GitHub 链接）：

```
https://raw.githubusercontent.com/YOUR-USERNAME/loon-telegram-adblocker/main/TelegramAdBlock.plugin
```

**步骤 2：在 Loon 中导入**

1. 打开 **Loon** 应用
2. 点击底部导航栏的 **「配置」** 标签页
3. 向下滚动找到 **「插件」** 部分
4. 点击 **「插件」** 右侧的 **「+」** 或 **「添加」** 按钮
5. 在弹出的对话框中：
   - **URL** 字段：粘贴上面复制的插件链接
   - **别名**（可选）：可以留空或输入 "Telegram 去广告"
6. 点击 **「保存」** 或 **「确定」**

**步骤 3：启用插件**

1. 在插件列表中找到刚刚添加的 **"Telegram 广告屏蔽"**
2. 确保右侧的开关是 **绿色（开启）** 状态
3. 如果是灰色，点击开关启用

### 方式二：本地导入

如果您下载了插件文件到本地：

**步骤 1：准备文件**

1. 确保已下载以下文件：
   - `TelegramAdBlock.plugin`
   - `telegram-adblocker.js`

**步骤 2：托管脚本文件**

您需要将 JavaScript 文件托管到可访问的位置：

- **选项 A**：使用 GitHub Gist 或 GitHub 仓库
- **选项 B**：使用自己的服务器
- **选项 C**：使用 iCloud Drive 配合 Shortcuts 生成分享链接

**步骤 3：修改插件配置**

编辑 `TelegramAdBlock.plugin` 文件，将脚本 URL 修改为您的托管地址：

```ini
[Script]
http-response ^https?:\/\/.*\.telegram\.org\/.*$ script-path=YOUR_SCRIPT_URL_HERE, requires-body=true, timeout=30, tag=Telegram去广告
```

**步骤 4：导入插件**

按照"方式一"的步骤导入修改后的插件 URL。

## 配置 MITM

**⚠️ 重要**：必须正确配置 MITM 证书，插件才能工作！

### 步骤 1：生成证书

1. 打开 **Loon** 应用
2. 点击底部 **「配置」** → 选择 **「MITM」**
3. 找到 **「证书管理」** 选项
4. 点击 **「生成新的 CA 证书」**
   - 如果已有证书，可以跳过此步骤
5. 等待证书生成完成（通常几秒钟）

### 步骤 2：安装证书到系统

1. 在证书管理页面，点击 **「安装 CA 证书」**
2. 系统会提示您前往"设置"应用
3. 打开 iOS **「设置」** 应用
4. 点击顶部的 **「已下载描述文件」**（或 "Profile Downloaded"）
5. 选择 **Loon CA** 证书
6. 点击右上角 **「安装」**
7. 输入设备密码
8. 点击 **「安装」** 确认（可能需要确认 2-3 次）
9. 安装完成后点击 **「完成」**

### 步骤 3：信任证书

**必须执行此步骤，否则 MITM 无法工作！**

1. 打开 iOS **「设置」** 应用
2. 依次进入：
   ```
   设置 → 通用 → 关于本机 → 证书信任设置
   ```
3. 在 **"针对根证书启用完全信任"** 部分：
4. 找到 **Loon** 开头的证书
5. 打开右侧的开关（变为绿色）
6. 在弹出的警告对话框中点击 **「继续」**

### 步骤 4：启用 MITM

1. 返回 **Loon** 应用
2. 进入 **「配置」** → **「MITM」**
3. 确保页面顶部的 **"MITM"** 开关是 **开启** 状态
4. 向下滚动到 **「域名」** 或 **「Hostname」** 部分
5. 确认列表中包含：
   ```
   *.telegram.org
   api.telegram.org
   ```
   - 如果插件正确安装，这些域名应该自动添加
   - 如果没有，可以手动添加

### 步骤 5：允许 VPN 配置

1. 返回 iOS **「设置」** 应用
2. 进入 **「通用」** → **「VPN 与设备管理」**
3. 确认 **Loon** VPN 配置存在且允许
4. 如果首次使用，Loon 会请求 VPN 权限，点击 **「允许」**

## 验证安装

### 1. 检查插件状态

1. 打开 **Loon**
2. 进入 **「配置」** → **「插件」**
3. 确认 **"Telegram 广告屏蔽"** 显示为 **已启用**

### 2. 启动 Loon VPN

1. 在 Loon 主界面
2. 点击中央的 **「启动」** 按钮或开关
3. 顶部状态栏应显示 VPN 图标

### 3. 测试广告屏蔽

1. 打开 **Telegram** 应用
2. 访问一些大型公开频道，例如：
   - 新闻频道
   - 科技频道
   - 大型社群频道
3. 观察是否还能看到标有 **"Sponsored"** 的消息
4. 如果赞助消息消失，说明插件工作正常 ✅

### 4. 查看日志（可选）

验证插件是否在运行：

1. 打开 **Loon**
2. 点击底部 **「工具」** 标签
3. 选择 **「日志」** 或 **「实时日志」**
4. 在 Telegram 中浏览几个频道
5. 查找包含 `[Telegram AdBlocker]` 的日志条目
6. 如果看到日志输出，说明脚本正在处理请求

## 问题排查

### 问题 1：插件无法导入

**症状**：粘贴 URL 后提示错误或无法保存

**解决方法**：
- ✅ 检查 URL 是否完整且正确
- ✅ 确认设备可以访问 GitHub（可能需要代理）
- ✅ 尝试在浏览器中打开 URL 查看是否可访问
- ✅ 检查 Loon 版本是否为 3.2.0 或更高

### 问题 2：MITM 证书安装失败

**症状**：无法下载或安装证书描述文件

**解决方法**：
- ✅ 确保 iOS 版本在 14.0 以上
- ✅ 检查设备是否设置了描述文件限制（MDM 管理的设备）
- ✅ 尝试重启 Loon 应用后重新生成证书
- ✅ 重启 iPhone 后再次尝试

### 问题 3：证书无法信任

**症状**：在"证书信任设置"中找不到 Loon 证书

**解决方法**：
- ✅ 确认证书已在"设置 > 通用 > 描述文件"中安装
- ✅ 尝试卸载并重新安装证书
- ✅ 等待 1-2 分钟后再检查（系统可能需要时间同步）

### 问题 4：插件不生效

**症状**：Telegram 中仍然显示广告

**解决方法**：
1. **检查 VPN 状态**：
   - 确认 Loon VPN 已启动
   - 状态栏应显示 VPN 图标

2. **检查插件启用**：
   - 进入 Loon 的"插件"页面
   - 确认插件开关为开启状态

3. **检查 MITM 配置**：
   - 进入 Loon 的"MITM"页面
   - 确认 MITM 开关已开启
   - 确认证书已信任
   - 确认域名列表包含 Telegram 域名

4. **检查脚本加载**：
   - 查看 Loon 日志
   - 如果没有任何 Telegram 相关日志，可能是脚本未加载
   - 尝试删除并重新添加插件

5. **清除 Telegram 缓存**：
   - 打开 Telegram 设置
   - 进入"数据和存储" → "存储用量"
   - 清除缓存后重启应用

### 问题 5：Telegram 无法连接

**症状**：启用插件后 Telegram 无法加载消息

**解决方法**：
- ✅ 暂时关闭插件，测试是否恢复
- ✅ 检查 MITM 证书是否正确信任
- ✅ 尝试关闭 MITM 并重新开启
- ✅ 检查网络连接是否正常
- ✅ 查看 Loon 日志是否有错误信息

### 问题 6：部分广告仍然显示

**症状**：某些频道的广告未被屏蔽

**原因**：
- Telegram 可能更新了广告 API 格式
- 某些广告使用了新的标识符

**解决方法**：
- ✅ 确认使用的是最新版本的插件
- ✅ 到 GitHub Issues 反馈具体情况
- ✅ 提供日志信息以帮助改进插件

## 高级配置

### 自定义域名拦截

如果您想添加更多域名到拦截列表：

1. 编辑插件配置或在 Loon 中手动添加规则
2. 在 `[Rule]` 部分添加：
   ```
   DOMAIN-SUFFIX,example-ad-domain.com,REJECT
   ```

### 调整脚本超时

如果网络较慢，可以增加脚本超时时间：

编辑插件文件中的 `timeout=30` 改为更大的值（如 `timeout=60`）。

### 查看详细日志

在 JavaScript 文件开头添加调试模式：

```javascript
const DEBUG = true;  // 启用调试日志
```

这会输出更详细的处理信息到 Loon 日志。

## 卸载插件

如果需要移除插件：

1. 打开 **Loon** 应用
2. 进入 **「配置」** → **「插件」**
3. 找到 **"Telegram 广告屏蔽"** 插件
4. 左滑或长按，选择 **「删除」**
5. 确认删除

卸载后，MITM 证书仍会保留，不会影响其他插件使用。

## 获取帮助

如果遇到无法解决的问题：

1. **查看文档**：
   - 阅读主 README.md
   - 查看本安装指南

2. **查看 Issues**：
   - 访问 GitHub Issues 页面
   - 搜索类似问题

3. **提交 Issue**：
   - 描述问题和重现步骤
   - 提供 Loon 日志截图
   - 说明设备和系统版本

4. **社区讨论**：
   - 在 GitHub Discussions 中提问
   - 与其他用户交流经验

---

**祝您使用愉快！** 🎉

如果插件对您有帮助，欢迎 Star ⭐ 本项目！
